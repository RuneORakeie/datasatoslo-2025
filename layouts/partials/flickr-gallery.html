{{/* layouts/partials/flickr-gallery.html */}}
{{ $apiKey := os.Getenv "HUGO_FLICKR_API_KEY" }}
{{ $photosPerPage := 20 }}

<div class="loading-spinner"></div>

<div class="gallery-wrapper">
    <div class="flickr-gallery">
        {{ if .Params.albums }}
        {{ range $index, $album := .Params.albums }}
        {{ $albumUrl := printf
        "https://api.flickr.com/services/rest/?method=flickr.photosets.getPhotos&api_key=%s&photoset_id=%s&user_id=%s&format=json&nojsoncallback=1"
        $apiKey $album.album_id $album.user_id }}

        <div class="flickr-album{{ if and (gt $index 0) (not $album.title) }} hidden-album{{ end }}"
            data-album-id="{{ $album.album_id }}" data-user-id="{{ $album.user_id }}" data-album-index="{{ $index }}">
            {{ with try (resources.GetRemote $albumUrl) }}
            {{ with .Err }}
            <div class="error-info">Error loading album {{ $album.album_id }}: {{ . }}</div>
            {{ else }}
            {{ with try (transform.Unmarshal .Value.Content) }}
            {{ with .Err }}
            <div class="error-info">Error parsing album data for {{ $album.album_id }}: {{ . }}</div>
            {{ else }}
            {{ $jsonData := .Value }}
            {{ if eq $jsonData.stat "ok" }}
            <div class="photos" data-total-photos="{{ len $jsonData.photoset.photo }}"
                data-loaded-photos="{{ $photosPerPage }}" data-current-page="1"
                data-is-last-album="{{ eq $index (sub (len $.Params.albums) 1) }}">
                {{ if $album.title }}
                <h3 class="album-title">{{ $album.title }}</h3>
                {{ end }}
                {{ range $photoIndex, $photo := $jsonData.photoset.photo }}
                {{ $thumbnailUrl := printf "https://live.staticflickr.com/%s/%s_%s_q.jpg" $photo.server $photo.id
                $photo.secret }}
                <a href="javascript:void(0);"
                    class="photo-container{{ if gt $photoIndex $photosPerPage }} hidden{{ end }}"
                    data-full-src="https://live.staticflickr.com/{{ $photo.server }}/{{ $photo.id }}_{{ $photo.secret }}_b.jpg"
                    data-photo-id="{{ $photo.id }}" data-album-index="{{ $index }}"
                    data-photo-index="{{ $photoIndex }}">
                    <img src="{{ if le $photoIndex $photosPerPage }}{{ $thumbnailUrl }}{{ else }}data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7{{ end }}"
                        data-src="{{ $thumbnailUrl }}"
                        data-full-src="https://live.staticflickr.com/{{ $photo.server }}/{{ $photo.id }}_{{ $photo.secret }}_b.jpg"
                        alt="{{ $photo.title }}" class="lazy{{ if gt $photoIndex $photosPerPage }} unloaded{{ end }}">
                </a>
                {{ end }}
                <div class="scroll-sentinel"></div>
            </div>
            {{ else }}
            <div class="error-info">Error loading album {{ $album.album_id }}: {{ $jsonData.message }}</div>
            {{ end }}
            {{ end }}
            {{ end }}
            {{ end }}
            {{ end }}
        </div>
        {{ end }}

        {{ else }}

        {{ $albumId := "" }}
        {{ $userId := "" }}
        {{ $albumId = .Params.album_id }}
        {{ $userId = .Params.user_id }}

        {{ $albumUrl := printf
        "https://api.flickr.com/services/rest/?method=flickr.photosets.getPhotos&api_key=%s&photoset_id=%s&user_id=%s&media=all&extras=media,url_q,url_m&format=json&nojsoncallback=1"
        $apiKey $albumId $userId }}

        <div class="flickr-album" data-album-id="{{ $albumId }}" data-user-id="{{ $userId }}" data-album-index="0">
            {{ with try (resources.GetRemote $albumUrl) }}
            {{ with .Err }}
            <div class="error-info">Error loading album: {{ . }}</div>
            {{ else }}
            {{ with try (transform.Unmarshal .Value.Content) }}
            {{ with .Err }}
            <div class="error-info">Error parsing album data: {{ . }}</div>
            {{ else }}
            {{ $jsonData := .Value }}

            {{ if eq $jsonData.stat "ok" }}
            <div class="photos" data-total-photos="{{ len $jsonData.photoset.photo }}"
                data-loaded-photos="{{ $photosPerPage }}" data-current-page="1" data-is-last-album="true">
                {{ range $index, $photo := $jsonData.photoset.photo }}
                {{ if eq $photo.media "video" }}
                <!-- Video container with improved thumbnail handling -->
                <a href="javascript:void(0);"
                    class="photo-container video-container{{ if gt $index $photosPerPage }} hidden{{ end }}"
                    data-media-type="video" data-photo-id="{{ $photo.id }}" data-user-id="{{ $userId }}"
                    data-video-secret="{{ $photo.secret }}" data-server="{{ $photo.server }}">
                    <div class="video-thumbnail-wrapper">
                        {{ $thumbnailUrl := "" }}
                        {{ if $photo.url_q }}
                        {{ $thumbnailUrl = $photo.url_q }}
                        {{ else if $photo.url_m }}
                        {{ $thumbnailUrl = $photo.url_m }}
                        {{ else }}
                        {{ $thumbnailUrl = printf "https://live.staticflickr.com/%s/%s_%s_q.jpg" $photo.server $photo.id
                        $photo.secret }}
                        {{ $fullSrc := printf "https://live.staticflickr.com/%s/%s_%s_b.jpg" $photo.server $photo.id
                        $photo.secret }}
                        {{ end }}
                        <img src="{{ if le $index $photosPerPage }}{{ $thumbnailUrl }}{{ else }}data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7{{ end }}"
                            data-src="{{ $thumbnailUrl }}" alt="{{ $photo.title }}"
                            class="lazy{{ if gt $index $photosPerPage }} unloaded{{ end }}">
                        <div class="play-button-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                class="play-icon">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                    </div>
                </a>
                {{ else }}
                {{ $photoUrl := printf "https://live.staticflickr.com/%s/%s_%s_z.jpg" $photo.server $photo.id
                $photo.secret }}
                {{ $thumbnailUrl := printf "https://live.staticflickr.com/%s/%s_%s_q.jpg" $photo.server $photo.id
                $photo.secret }}

                <a href="javascript:void(0);" class="photo-container{{ if gt $index $photosPerPage }} hidden{{ end }}"
                    data-full-src="https://live.staticflickr.com/{{ $photo.server }}/{{ $photo.id }}_{{ $photo.secret }}_b.jpg"
                    data-photo-id="{{ $photo.id }}">
                    <img src="{{ if le $index $photosPerPage }}{{ $thumbnailUrl }}{{ else }}data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7{{ end }}"
                        data-src="{{ $thumbnailUrl }}"
                        data-full-src="https://live.staticflickr.com/{{ $photo.server }}/{{ $photo.id }}_{{ $photo.secret }}_b.jpg"
                        alt="{{ $photo.title }}" class="lazy{{ if gt $index $photosPerPage }} unloaded{{ end }}">
                </a>
                {{ end }}
                {{ end }}
                <div class="scroll-sentinel"></div>
            </div>
            {{ else }}
            <div class="error-info">Error: {{ $jsonData.message }}</div>
            {{ end }}
            {{ end }}
            {{ end }}
            {{ end }}
            {{ end }}
        </div>

        {{ end }}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // 1️⃣ Determine if running locally or in Azure
        const isLocal = window.location.hostname === "localhost";
        let flickrApiKey = "";

        async function fetchFlickrApiKey() {
            const apiUrl = isLocal
                ? "http://localhost:7071/api/GetFlickrKey"  // Local function
                : "/api/GetFlickrKey";  // Azure function

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.apiKey) {
                    window.flickrApiKey = data.apiKey;
                    // enable for debug only console.log("Fetched Flickr API Key:", window.flickrApiKey);
                } else {
                    console.error("Failed to fetch Flickr API key:", data);
                }
            } catch (error) {
                console.error("Error fetching Flickr API key:", error);
            }
        }

        await fetchFlickrApiKey(); // Call this before any Flickr-related code runs

        const loadingSpinner = document.querySelector('.loading-spinner');
        let isLoading = false;
        let currentAlbumIndex = 0;
        let allPhotosLoaded = false;
        // Initialize containers array to include both photos and videos
        const mediaContainers = Array.from(document.querySelectorAll('.photo-container, .video-container'));

        function showLoading() {
            isLoading = true;
            loadingSpinner.classList.add('visible');
        }

        function hideLoading() {
            isLoading = false;
            loadingSpinner.classList.remove('visible');
        }

        function loadNextAlbum() {
            const nextAlbum = document.querySelector(`.flickr-album[data-album-index="${currentAlbumIndex + 1}"]`);
            if (nextAlbum && nextAlbum.classList.contains('hidden-album')) {
                nextAlbum.classList.remove('hidden-album');
                currentAlbumIndex++;

                // Initialize the newly revealed album's photos
                const photos = nextAlbum.querySelectorAll('img.lazy:not(.unloaded)');
                photos.forEach(img => {
                    imageObserver.observe(img);
                });

                // Reset scroll detection for the new album
                setupScrollDetection(nextAlbum.querySelector('.photos'));
                return true;
            }
            return false;
        }

        function adjustFooterPosition() {
            const footer = document.querySelector("body > footer");
            const mainContent = document.querySelector("main");
            const galleryWrapper = document.querySelector(".gallery-wrapper");

            if (!galleryWrapper || !footer || !mainContent) return;

            requestAnimationFrame(() => {
                const galleryBottom = galleryWrapper.getBoundingClientRect().bottom + window.scrollY;
                const footerHeight = footer.offsetHeight;
                const viewportHeight = window.innerHeight;
                const currentBodyHeight = document.documentElement.scrollHeight;

                const newHeight = Math.max(galleryBottom + footerHeight, viewportHeight);
                if (Math.abs(newHeight - currentBodyHeight) > 5) {
                    document.body.style.height = `${newHeight}px`;
                    mainContent.style.minHeight = `${newHeight - footerHeight}px`;
                }
            });
        }

        async function getVideoThumbnail(photoId, userId) {
            try {
                const thumbnailUrl = `https://live.staticflickr.com/${server}/${photoId}_${secret}_q.jpg`;
                return thumbnailUrl;
            } catch (error) {
                console.error('Error fetching video thumbnail:', error);
                return null;
            }
        }

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.classList.contains('unloaded')) {
                        showLoading();
                        const container = img.closest('.video-container, .photo-container');

                        if (container && container.classList.contains('video-container')) {
                            // Handle video thumbnails
                            const photoId = container.dataset.photoId;
                            const userId = container.dataset.userId;
                            getVideoThumbnail(photoId, userId, flickrApiKey).then(thumbnailUrl => {
                                if (thumbnailUrl) {
                                    img.src = thumbnailUrl;
                                }
                                img.classList.remove('unloaded');
                                hideLoading();
                            });
                        } else {
                            // Handle regular photos - simple and direct
                            img.src = img.dataset.src;
                            img.classList.remove('unloaded');
                            hideLoading();
                        }
                        adjustFooterPosition();
                    }
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.1
        });

        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) + 100
            );
        }

        function loadMorePhotos(container) {
            if (isLoading || !container) return false;

            const totalPhotos = parseInt(container.dataset.totalPhotos);
            const loadedPhotos = parseInt(container.dataset.loadedPhotos);
            const batchSize = 20;
            const isLastAlbum = container.dataset.isLastAlbum === 'true';

            if (loadedPhotos >= totalPhotos) {
                if (!isLastAlbum && !container.dataset.nextAlbumLoaded) {
                    container.dataset.nextAlbumLoaded = 'true';
                    if (loadNextAlbum()) {
                        return true;
                    }
                }
                return false;
            }

            showLoading();

            const nextBatch = Math.min(batchSize, totalPhotos - loadedPhotos);
            const startIndex = loadedPhotos;
            const endIndex = startIndex + nextBatch;

            const hiddenPhotos = Array.from(container.querySelectorAll('.photo-container.hidden'))
                .slice(0, nextBatch);

            if (hiddenPhotos.length > 0) {
                hiddenPhotos.forEach(photo => {
                    photo.classList.remove('hidden');
                    const img = photo.querySelector('img.unloaded');
                    if (img) {
                        imageObserver.observe(img);
                    }
                });

                container.dataset.loadedPhotos = endIndex;
                setTimeout(() => {
                    hideLoading();
                    adjustFooterPosition();
                }, 100);
                return true;
            }

            hideLoading();
            return false;
        }

        function setupScrollDetection(container) {
            if (!container) return;

            const sentinel = container.querySelector('.scroll-sentinel');
            if (!sentinel) return;

            const scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        loadMorePhotos(container);
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.1
            });

            scrollObserver.observe(sentinel);
        }

        // Initialize all albums (whether single or multiple)
        document.querySelectorAll('.flickr-album').forEach((album) => {
            // For single album case, ensure data-album-index exists
            if (!album.hasAttribute('data-album-index')) {
                album.setAttribute('data-album-index', '0');
            }

            // Only initialize visible albums
            if (!album.classList.contains('hidden-album')) {
                const photos = album.querySelectorAll('img.lazy:not(.unloaded)');
                photos.forEach(img => {
                    imageObserver.observe(img);
                });

                const photoContainer = album.querySelector('.photos');
                if (photoContainer && !photoContainer.hasAttribute('data-is-last-album')) {
                    photoContainer.setAttribute('data-is-last-album', 'true');
                }

                setupScrollDetection(photoContainer);
            }
        });

        // Handle scroll events for dynamic loading
        window.addEventListener('scroll', () => {
            if (isLoading) return;

            const currentAlbum = document.querySelector(`.flickr-album[data-album-index="${currentAlbumIndex}"]`);
            if (!currentAlbum) return;

            const container = currentAlbum.querySelector('.photos');
            if (container) {
                const sentinel = container.querySelector('.scroll-sentinel');
                if (sentinel && isInViewport(sentinel)) {
                    loadMorePhotos(container);
                }
            }
        }, { passive: true });

        // Check initial viewport state
        window.addEventListener('load', () => {
            const firstAlbum = document.querySelector('.flickr-album');
            if (firstAlbum) {
                const container = firstAlbum.querySelector('.photos');
                if (container) {
                    loadMorePhotos(container);
                }
            }
            adjustFooterPosition();
        });
        // Function to get video URL
        async function getVideoUrl(photoId, userId, apiKey) {
            try {
                const videoSource = `https://www.flickr.com/video_download.gne?id=${photoId}`;
                return videoSource;
            } catch (error) {
                console.error('Error fetching video URL:', error);
                return null;
            }
        }

        // Handle modal view
        const photos = Array.from(document.querySelectorAll('.photo-container'));
        let currentIndex = -1;

        async function openModal(index) {
            if (index < 0 || index >= mediaContainers.length) return;

            currentIndex = index;
            const container = mediaContainers[index];
            const mediaType = container.dataset.mediaType || 'photo'; // fallback to 'photo' if not set

            // Remove existing modal if already open
            const existingModal = document.querySelector('.photo-modal, .video-modal');
            if (existingModal) existingModal.remove();

            if (mediaType === 'video') {
                showLoading();
                const photoId = container.dataset.photoId;
                const userId = container.dataset.userId;
                console.log('Opening video with ID:', photoId);
                const videoUrl = await getVideoUrl(photoId);
                hideLoading();

                if (!videoUrl) {
                    console.error('Failed to get video URL');
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'video-modal photo-modal';
                modal.innerHTML = `
            <div class="modal-content">
                <button class="modal-prev" style="display: ${index === 0 ? 'none' : 'block'};"> < </button>
                <div class="video-wrapper">
                    <video controls autoplay playsInline>
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <button class="modal-next" style="display: ${index === mediaContainers.length - 1 ? 'none' : 'block'};"> > </button>
                <button class="close-modal">&times;</button>
            </div>
        `;

                document.body.appendChild(modal);

                // Add error handling for video
                const video = modal.querySelector('video');
                video.addEventListener('error', (e) => {
                    console.error('Video error:', video.error);
                    // Show error message to user
                    const videoWrapper = modal.querySelector('.video-wrapper');
                    videoWrapper.innerHTML = `
                <div class="video-error">
                    <p>Sorry, the video could not be loaded.</p>
                    <p>Error: ${video.error?.message || 'Unknown error'}</p>
                </div>
            `;
                });
            } else {
                const imgElement = container.querySelector('img');
                const fullUrl = imgElement.dataset.fullSrc;

                const modal = document.createElement('div');
                modal.className = 'photo-modal';
                modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-prev" style="display: ${index === 0 ? 'none' : 'block'};"> < </button>
                    <img src="${fullUrl}" alt="">
                    <button class="modal-next" style="display: ${index === mediaContainers.length - 1 ? 'none' : 'block'};"> > </button>
                    <button class="close-modal">&times;</button>
                </div>
            `;

                document.body.appendChild(modal);
            }

            // Add event listeners
            const modal = document.querySelector('.photo-modal');
            modal.querySelector('.modal-prev').addEventListener('click', () => navigateModal(-1));
            modal.querySelector('.modal-next').addEventListener('click', () => navigateModal(1));
            modal.querySelector('.close-modal').addEventListener('click', closeModal);

            // Listen for keyboard events
            document.addEventListener('keydown', handleKeydown);


            // Attach event listeners to each container
            mediaContainers.forEach((container, index) => {
                container.addEventListener('click', function (e) {
                    e.preventDefault();
                    openModal(index);
                });
            });
        }

        async function navigateModal(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex < 0 || newIndex >= photos.length) return;

            currentIndex = newIndex;
            const container = photos[newIndex];
            const mediaType = container.dataset.mediaType;

            if (mediaType === 'video') {
                // Handle video navigation
                const photoId = container.dataset.photoId;
                showLoading();
                const videoUrl = await getVideoUrl(photoId, flickrApiKey);
                hideLoading();

                if (!videoUrl) {
                    console.error('Failed to load video URL');
                    return;
                }

                // Replace image with video player
                const modalContent = document.querySelector('.photo-modal .modal-content');
                modalContent.innerHTML = `
            <button class="modal-prev" style="display: ${newIndex === 0 ? 'none' : 'block'};"> < </button>
            <video controls autoplay>
                <source src="${videoUrl}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <button class="modal-next" style="display: ${newIndex === photos.length - 1 ? 'none' : 'block'};"> > </button>
            <button class="close-modal">&times;</button>
        `;

                // Reattach event listeners
                modalContent.querySelector('.modal-prev').addEventListener('click', () => navigateModal(-1));
                modalContent.querySelector('.modal-next').addEventListener('click', () => navigateModal(1));
                modalContent.querySelector('.close-modal').addEventListener('click', closeModal);
            } else {
                // Existing photo navigation code
                const newImgElement = container.querySelector('img');
                const newFullUrl = newImgElement.dataset.fullSrc;

                // Update modal image source
                const modalImg = document.querySelector('.photo-modal img');
                if (!modalImg) {
                    // If we're coming from a video, rebuild the photo structure
                    const modalContent = document.querySelector('.photo-modal .modal-content');
                    modalContent.innerHTML = `
                <button class="modal-prev" style="display: ${newIndex === 0 ? 'none' : 'block'};"> < </button>
                <img src="${newFullUrl}" alt="">
                <button class="modal-next" style="display: ${newIndex === photos.length - 1 ? 'none' : 'block'};"> > </button>
                <button class="close-modal">&times;</button>
            `;

                    // Reattach event listeners
                    modalContent.querySelector('.modal-prev').addEventListener('click', () => navigateModal(-1));
                    modalContent.querySelector('.modal-next').addEventListener('click', () => navigateModal(1));
                    modalContent.querySelector('.close-modal').addEventListener('click', closeModal);
                } else {
                    // Update modal image source
                    modalImg.src = newFullUrl;

                    // Show/hide arrows dynamically
                    document.querySelector('.modal-prev').style.display = newIndex === 0 ? 'none' : 'block';
                    document.querySelector('.modal-next').style.display = newIndex === photos.length - 1 ? 'none' : 'block';
                }
            }
        }

        function closeModal() {
            const modal = document.querySelector('.photo-modal');
            if (modal) modal.remove();

            document.removeEventListener('keydown', handleKeydown);
        }

        function handleKeydown(event) {
            if (event.key === 'ArrowRight') navigateModal(1);
            if (event.key === 'ArrowLeft') navigateModal(-1);
            if (event.key === 'Escape') closeModal();
        }

        // Attach event listeners to each photo-container
        photos.forEach((photo, index) => {
            photo.addEventListener('click', function (e) {
                e.preventDefault();
                openModal(index);
            });
        });
    });
</script>