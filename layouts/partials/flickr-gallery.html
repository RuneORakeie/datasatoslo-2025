{{/* layouts/partials/flickr-gallery.html */}}
{{ $photosPerPage := 20 }}

<div class="loading-spinner"></div>

<div class="gallery-wrapper">
    <div class="flickr-gallery">
        {{ if .Params.albums }}
        {{ range $index, $album := .Params.albums }}

        <div class="flickr-album{{ if and (gt $index 0) (not $album.title) }} hidden-album{{ end }}"
            data-album-id="{{ $album.album_id }}" data-user-id="{{ $album.user_id }}" data-album-index="{{ $index }}"
            data-needs-photos="true">
            {{ if $album.title }}
            <h3 class="album-title">{{ $album.title }}</h3>
            {{ end }}
            <div class="photos" data-loaded-photos="{{ $photosPerPage }}" data-current-page="1"
                data-is-last-album="{{ eq $index (sub (len $.Params.albums) 1) }}">
                <div class="scroll-sentinel"></div>
            </div>
        </div>
        {{ end }}

        {{ else }}

        {{ $albumId := "" }}
        {{ $userId := "" }}
        {{ $albumId = .Params.album_id }}
        {{ $userId = .Params.user_id }}

        <div class="flickr-album" data-album-id="{{ $albumId }}" data-user-id="{{ $userId }}" data-album-index="0"
            data-needs-photos="true">
            <div class="photos" data-loaded-photos="{{ $photosPerPage }}" data-current-page="1"
                data-is-last-album="true">
                <div class="scroll-sentinel"></div>
            </div>
        </div>

        {{ end }}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // 1Ô∏è‚É£ Determine if running locally or in Azure
        const isLocal = window.location.hostname === "localhost";
        const loadingSpinner = document.querySelector('.loading-spinner');
        let isLoading = false;
        let currentAlbumIndex = 0;
        let allPhotosLoaded = false;
        let mediaContainers = [];
        let currentIndex = -1;


        function showLoading() {
            isLoading = true;
            loadingSpinner.classList.add('visible');
        }

        function hideLoading() {
            isLoading = false;
            loadingSpinner.classList.remove('visible');
        }


        function adjustFooterPosition() {
            const footer = document.querySelector("body > footer");
            const mainContent = document.querySelector("main");
            const galleryWrapper = document.querySelector(".gallery-wrapper");

            if (!galleryWrapper || !footer || !mainContent) return;

            requestAnimationFrame(() => {
                const galleryBottom = galleryWrapper.getBoundingClientRect().bottom + window.scrollY;
                const footerHeight = footer.offsetHeight;
                const viewportHeight = window.innerHeight;
                const currentBodyHeight = document.documentElement.scrollHeight;

                const newHeight = Math.max(galleryBottom + footerHeight, viewportHeight);
                if (Math.abs(newHeight - currentBodyHeight) > 5) {
                    document.body.style.height = `${newHeight}px`;
                    mainContent.style.minHeight = `${newHeight - footerHeight}px`;
                }
            });
        }

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.classList.contains('unloaded')) {
                        showLoading();
                        const container = img.closest('.video-container, .photo-container');

                        if (container && container.classList.contains('video-container')) {
                            // Handle video thumbnails
                            const photoId = container.dataset.photoId;
                            const userId = container.dataset.userId;
                            getVideoThumbnail(photoId, userId, flickrApiKey).then(thumbnailUrl => {
                                if (thumbnailUrl) {
                                    img.src = thumbnailUrl;
                                }
                                img.classList.remove('unloaded');
                                hideLoading();
                            });
                        } else {
                            // Handle regular photos - simple and direct
                            img.src = img.dataset.src;
                            img.classList.remove('unloaded');
                            hideLoading();
                        }
                        adjustFooterPosition();
                    }
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.1
        });

        async function fetchFlickrApiKey() {
            const apiUrl = isLocal
                ? "http://localhost:7071/api/GetFlickrKey"  // Local function
                : "/api/GetFlickrKey";  // Azure function

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.apiKey) {
                    // Log API key for debugging
                    // console.log("‚úÖ Flickr API Key Retrieved:", JSON.stringify(data.apiKey));
                    return data.apiKey.trim(); // Remove extra spaces if needed
                }
                throw new Error('No API key in response');
            } catch (error) {
                console.error("Error fetching Flickr API key:", error);
                return null;
            }
        }

        async function fetchAlbumPhotos(albumId, userId, apiKey) {
            // console.log('üîÑ Fetching album photos from Flickr API...');
            const albumUrl = `https://api.flickr.com/services/rest/?method=flickr.photosets.getPhotos&api_key=${apiKey}&photoset_id=${albumId}&user_id=${userId}&media=all&extras=media,url_q,url_m&format=json&nojsoncallback=1`;
            // console.log('üì° API URL:', albumUrl);

            try {
                const response = await fetch(albumUrl);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching album photos:', error);
                return null;
            }
        }

        function createVideoContainer(photo, index, userId) {
            const container = document.createElement('a');
            container.href = 'javascript:void(0);';
            container.className = `photo-container video-container${index > 20 ? ' hidden' : ''}`;
            container.dataset.mediaType = 'video';
            container.dataset.photoId = photo.id;
            container.dataset.userId = userId;
            container.dataset.videoSecret = photo.secret;
            container.dataset.server = photo.server;

            const thumbnailUrl = photo.url_q || photo.url_m ||
                `https://live.staticflickr.com/${photo.server}/${photo.id}_${photo.secret}_q.jpg`;

            container.innerHTML = `
            <div class="video-thumbnail-wrapper">
                <img src="${index <= 20 ? thumbnailUrl : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}"
                    data-src="${thumbnailUrl}"
                    alt="${photo.title}"
                    class="lazy${index > 20 ? ' unloaded' : ''}">
                <div class="play-button-overlay">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </div>
            </div>
        `;

            return container;
        }

        function createPhotoContainer(photo, index) {
            const container = document.createElement('a');
            container.href = 'javascript:void(0);';
            container.className = `photo-container${index > 20 ? ' hidden' : ''}`;

            const thumbnailUrl = `https://live.staticflickr.com/${photo.server}/${photo.id}_${photo.secret}_q.jpg`;
            const fullSrc = `https://live.staticflickr.com/${photo.server}/${photo.id}_${photo.secret}_b.jpg`;

            container.dataset.fullSrc = fullSrc;
            container.dataset.photoId = photo.id;

            container.innerHTML = `
            <img src="${index <= 20 ? thumbnailUrl : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}"
                data-src="${thumbnailUrl}"
                data-full-src="${fullSrc}"
                alt="${photo.title}"
                class="lazy${index > 20 ? ' unloaded' : ''}">
        `;

            return container;
        }

        async function loadAlbumPhotos(album, apiKey) {
            // console.log('üìÇ Loading album photos...');
            const albumId = album.dataset.albumId;
            const userId = album.dataset.userId;
            const photosContainer = album.querySelector('.photos');
            console.log('Album data:', { albumId, userId });

            if (!albumId || !userId || !photosContainer) return;

            const data = await fetchAlbumPhotos(albumId, userId, apiKey);

            if (!data || data.stat !== 'ok') {
                album.innerHTML = `<div class="error-info">Error loading album: ${data?.message || 'Unknown error'}</div>`;
                return;
            }

            // Update total photos count
            photosContainer.dataset.totalPhotos = data.photoset.photo.length;

            // Create and append photo elements
            data.photoset.photo.forEach((photo, index) => {
                if (photo.media === "video") {
                    const videoContainer = createVideoContainer(photo, index, userId);
                    photosContainer.insertBefore(videoContainer, photosContainer.querySelector('.scroll-sentinel'));
                } else {
                    const photoContainer = createPhotoContainer(photo, index);
                    photosContainer.insertBefore(photoContainer, photosContainer.querySelector('.scroll-sentinel'));
                }
            });

            // Initialize lazy loading for the first batch
            initializeLazyLoading(album);
            setupScrollDetection(photosContainer);

            // Remove the loading flag
            album.dataset.needsPhotos = "false";

            // Update mediaContainers array
            mediaContainers = Array.from(document.querySelectorAll('.photo-container, .video-container'));
        }

        function loadNextAlbum() {
            // console.log('üé¨ Starting loadNextAlbum, current index:', currentAlbumIndex);
            const nextAlbum = document.querySelector(`.flickr-album[data-album-index="${currentAlbumIndex + 1}"]`);
            // console.log('üîç Found next album:', nextAlbum ? 'Yes' : 'No');

            /*if (nextAlbum) {
                 console.log('üìù Next album state:', {
                    isHidden: nextAlbum.classList.contains('hidden-album'),
                    albumId: nextAlbum.dataset.albumId,
                    index: nextAlbum.dataset.albumIndex
                });
                
            }*/

            if (nextAlbum && nextAlbum.classList.contains('hidden-album')) {
                // console.log('üîì Revealing next album');
                nextAlbum.classList.remove('hidden-album');
                currentAlbumIndex++;

                // Set up scroll detection for the newly revealed album
                const photoContainer = nextAlbum.querySelector('.photos');
                if (photoContainer) {
                    // console.log('üì∏ Setting up photo container for next album');
                    setupScrollDetection(photoContainer);

                    // Show the first batch of photos
                    const hiddenPhotos = Array.from(photoContainer.querySelectorAll('.photo-container.hidden'))
                        .slice(0, 20);

                    // console.log('üñºÔ∏è Found hidden photos:', hiddenPhotos.length);

                    hiddenPhotos.forEach(photo => {
                        photo.classList.remove('hidden');
                        const img = photo.querySelector('img.unloaded');
                        if (img) {
                            imageObserver.observe(img);
                        }
                    });

                    // Update the loaded photos count
                    photoContainer.dataset.loadedPhotos = hiddenPhotos.length;
                    adjustFooterPosition();
                }

                return true;
            }
            // console.log('‚ùå No next album to load');
            return false;
        }

        function initializeLazyLoading(album) {
            const photos = album.querySelectorAll('img.lazy:not(.unloaded)');
            photos.forEach(img => {
                imageObserver.observe(img);
            });
        }

        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            const inView = rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) + 100;
            /*console.log('üéØ Sentinel viewport check:', {
                bottom: rect.bottom,
                threshold: window.innerHeight + 100,
                inView: inView
            });*/
            return inView;
        }

        function loadMorePhotos(container) {
            if (isLoading || !container) {
                // console.log('‚ö†Ô∏è LoadMorePhotos blocked:', { isLoading, hasContainer: !!container });
                return false;
            }

            const totalPhotos = parseInt(container.dataset.totalPhotos);
            const loadedPhotos = parseInt(container.dataset.loadedPhotos);
            const batchSize = 20;
            const isLastAlbum = container.dataset.isLastAlbum === 'true';

/*            console.log('üìä LoadMorePhotos status:', {
                totalPhotos,
                loadedPhotos,
                isLastAlbum,
                hasNextAlbumFlag: container.dataset.nextAlbumLoaded
            });*/

            if (loadedPhotos >= totalPhotos-1) {
                // console.log('üîÑ All photos loaded in current album, checking for next album...');
                if (!isLastAlbum && !container.dataset.nextAlbumLoaded) {
                    // console.log('‚û°Ô∏è Attempting to load next album...');
                    container.dataset.nextAlbumLoaded = 'true';
                    if (loadNextAlbum()) {
                        // console.log('‚úÖ Next album loaded successfully');
                        return true;
                    }
                    // console.log('‚ùå Failed to load next album');
                }
                return false;
            }

            showLoading();
            // console.log('üì∏ Loading more photos in current album');

            const remainingPhotos = totalPhotos - loadedPhotos;
            const photosToLoad = Math.min(batchSize, remainingPhotos);

            const hiddenPhotos = Array.from(container.querySelectorAll('.photo-container.hidden'))
                .slice(0, photosToLoad);
/*
            console.log('üî¢ Loading batch:', {
                remainingPhotos,
                photosToLoad,
                hiddenPhotosFound: hiddenPhotos.length
            });
*/
            if (hiddenPhotos.length > 0) {
                // console.log('üñºÔ∏è Revealing batch of', hiddenPhotos.length, 'photos');
                hiddenPhotos.forEach(photo => {
                    photo.classList.remove('hidden');
                    const img = photo.querySelector('img.unloaded');
                    if (img) {
                        imageObserver.observe(img);
                    }
                });

                container.dataset.loadedPhotos = parseInt(container.dataset.loadedPhotos) + hiddenPhotos.length;
                // console.log('‚ú® New loaded photos count:', container.dataset.loadedPhotos);

                setTimeout(() => {
                    hideLoading();
                    adjustFooterPosition();
                }, 100);
                return true;
            }

            hideLoading();
            return false;
        }


        function setupScrollDetection(container) {
            if (!container) {
                // console.log('‚ö†Ô∏è No container provided for scroll detection');
                return;
            }

            const sentinel = container.querySelector('.scroll-sentinel');
            if (!sentinel) {
                // console.log('‚ö†Ô∏è No sentinel found in container');
                return;
            }

            // console.log('üëÄ Setting up scroll detection for container');
            const scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    /*console.log('üîÑ Scroll intersection:', {
                        isIntersecting: entry.isIntersecting,
                        ratio: entry.intersectionRatio
                    });*/
                    if (entry.isIntersecting) {
                        loadMorePhotos(container);
                    }
                });
            }, {
                rootMargin: '200px 0px',
                threshold: 0.1
            });

            scrollObserver.observe(sentinel);
        }

        // Modal functionality
        async function getVideoUrl(photoId) {
            return `https://www.flickr.com/video_download.gne?id=${photoId}`;
        }

        async function openModal(index) {
            if (index < 0 || index >= mediaContainers.length) return;

            currentIndex = index;
            const container = mediaContainers[index];
            const mediaType = container.dataset.mediaType || 'photo';

            const existingModal = document.querySelector('.photo-modal, .video-modal');
            if (existingModal) existingModal.remove();

            if (mediaType === 'video') {
                showLoading();
                const photoId = container.dataset.photoId;
                const videoUrl = await getVideoUrl(photoId);
                hideLoading();

                if (!videoUrl) {
                    console.error('Failed to get video URL');
                    return;
                }

                createVideoModal(videoUrl, index);
            } else {
                createPhotoModal(container, index);
            }

            // Add event listeners
            const modal = document.querySelector('.photo-modal');
            modal.querySelector('.modal-prev').addEventListener('click', () => navigateModal(-1));
            modal.querySelector('.modal-next').addEventListener('click', () => navigateModal(1));
            modal.querySelector('.close-modal').addEventListener('click', closeModal);
            document.addEventListener('keydown', handleKeydown);
        }

        function createVideoModal(videoUrl, index) {
            const modal = document.createElement('div');
            modal.className = 'video-modal photo-modal';
            modal.innerHTML = `
            <div class="modal-content">
                <button class="modal-prev" style="display: ${index === 0 ? 'none' : 'block'};"> < </button>
                <div class="video-wrapper">
                    <video controls autoplay playsInline>
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <button class="modal-next" style="display: ${index === mediaContainers.length - 1 ? 'none' : 'block'};"> > </button>
                <button class="close-modal">&times;</button>
            </div>
        `;

            document.body.appendChild(modal);

            const video = modal.querySelector('video');
            video.addEventListener('error', (e) => {
                console.error('Video error:', video.error);
                const videoWrapper = modal.querySelector('.video-wrapper');
                videoWrapper.innerHTML = `
                <div class="video-error">
                    <p>Sorry, the video could not be loaded.</p>
                    <p>Error: ${video.error?.message || 'Unknown error'}</p>
                </div>
            `;
            });
        }

        function createPhotoModal(container, index) {
            const imgElement = container.querySelector('img');
            const fullUrl = imgElement.dataset.fullSrc;

            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
            <div class="modal-content">
                <button class="modal-prev" style="display: ${index === 0 ? 'none' : 'block'};"> < </button>
                <img src="${fullUrl}" alt="">
                <button class="modal-next" style="display: ${index === mediaContainers.length - 1 ? 'none' : 'block'};"> > </button>
                <button class="close-modal">&times;</button>
            </div>
        `;

            document.body.appendChild(modal);
        }

        async function navigateModal(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex < 0 || newIndex >= mediaContainers.length) return;

            currentIndex = newIndex;
            const container = mediaContainers[newIndex];
            const mediaType = container.dataset.mediaType;

            if (mediaType === 'video') {
                const photoId = container.dataset.photoId;
                showLoading();
                const videoUrl = await getVideoUrl(photoId);
                hideLoading();

                if (!videoUrl) {
                    console.error('Failed to load video URL');
                    return;
                }

                updateModalContent(createVideoModalContent(videoUrl, newIndex));
            } else {
                const imgElement = container.querySelector('img');
                const newFullUrl = imgElement.dataset.fullSrc;
                updateModalContent(createPhotoModalContent(newFullUrl, newIndex));
            }

            // Reattach event listeners
            const modalContent = document.querySelector('.photo-modal .modal-content');
            modalContent.querySelector('.modal-prev').addEventListener('click', () => navigateModal(-1));
            modalContent.querySelector('.modal-next').addEventListener('click', () => navigateModal(1));
            modalContent.querySelector('.close-modal').addEventListener('click', closeModal);
        }

        function createVideoModalContent(videoUrl, index) {
            return `
            <button class="modal-prev" style="display: ${index === 0 ? 'none' : 'block'};"> < </button>
            <div class="video-wrapper">
                <video controls autoplay playsInline>
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <button class="modal-next" style="display: ${index === mediaContainers.length - 1 ? 'none' : 'block'};"> > </button>
            <button class="close-modal">&times;</button>
        `;
        }

        function createPhotoModalContent(fullUrl, index) {
            return `
            <button class="modal-prev" style="display: ${index === 0 ? 'none' : 'block'};"> < </button>
            <img src="${fullUrl}" alt="">
            <button class="modal-next" style="display: ${index === mediaContainers.length - 1 ? 'none' : 'block'};"> > </button>
            <button class="close-modal">&times;</button>
        `;
        }

        function updateModalContent(content) {
            const modalContent = document.querySelector('.photo-modal .modal-content');
            if (modalContent) {
                modalContent.innerHTML = content;
            }
        }

        function closeModal() {
            const modal = document.querySelector('.photo-modal');
            if (modal) modal.remove();
            document.removeEventListener('keydown', handleKeydown);
        }

        function handleKeydown(event) {
            if (event.key === 'ArrowRight') navigateModal(1);
            if (event.key === 'ArrowLeft') navigateModal(-1);
            if (event.key === 'Escape') closeModal();
        }

        // Initialize gallery
        async function initializeGallery() {
            // console.log('üöÄ Starting gallery initialization');
            showLoading();
            // console.log('‚è≥ Fetching Flickr API key...');
            const apiKey = await fetchFlickrApiKey();
            // console.log('üîë API Key fetch result:', apiKey ? 'Success' : 'Failed');

            if (!apiKey) {
                document.querySelector('#flickrGallery').innerHTML =
                    '<div class="error-info">Failed to initialize gallery: Could not fetch API key</div>';
                hideLoading();
                return;
            }

            // Store API key for later use
            window.flickrApiKey = apiKey;

            // Load all albums that need photos, regardless of visibility
            // console.log('üîç Looking for albums to load...');
            const albums = document.querySelectorAll('.flickr-album[data-needs-photos="true"]');
            // console.log('üìÅ Found albums:', albums.length);

            for (const album of albums) {
                /*console.log('üíΩ Loading album:', {
                    id: album.dataset.albumId,
                    userId: album.dataset.userId,
                    hidden: album.classList.contains('hidden-album')
                });*/
                // Load the photos but keep the album hidden if it has the hidden-album class
                const wasHidden = album.classList.contains('hidden-album');
                if (wasHidden) {
                    album.classList.remove('hidden-album');
                }
                await loadAlbumPhotos(album, apiKey);
                if (wasHidden) {
                    album.classList.add('hidden-album');
                }
            }

            // Set up the scroll observer for the first visible album
            const firstAlbum = document.querySelector('.flickr-album:not(.hidden-album)');
            if (firstAlbum) {
                const container = firstAlbum.querySelector('.photos');
                setupScrollDetection(container);
            }

            // Add click handlers for all media containers
            mediaContainers.forEach((container, index) => {
                container.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(index);
                });
            });

            // Handle scroll events for dynamic loading
            window.addEventListener('scroll', () => {
                if (isLoading) return;

                const currentAlbum = document.querySelector(`.flickr-album[data-album-index="${currentAlbumIndex}"]`);
                if (!currentAlbum) return;

                const container = currentAlbum.querySelector('.photos');
                if (container) {
                    const sentinel = container.querySelector('.scroll-sentinel');
                    if (sentinel && isInViewport(sentinel)) {
                        loadMorePhotos(container);
                    }
                }
            }, { passive: true });

            // Check initial viewport state
            window.addEventListener('load', () => {
                const firstAlbum = document.querySelector('.flickr-album');
                if (firstAlbum) {
                    const container = firstAlbum.querySelector('.photos');
                    if (container) {
                        loadMorePhotos(container);
                    }
                }
                adjustFooterPosition();
            });

            hideLoading();
        }

        // Start initialization
        initializeGallery();
    });
</script>